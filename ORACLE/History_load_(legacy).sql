/*Load from DESEAI01.DEMAND_SALES_DET_RAW. SA not included*/
DECLARE YM NUMBER:=0;
BEGIN
 FOR i IN 24093..24242
 LOOP /*Loop counter in YEARMONTH_MONTHS*/
  YM:=DWSEAI01.YMM2YM(i); /*DWSEAI01.YMM2YM converts YEARMONTH_MONTHS to YEARMONTH*/
  INSERT  /*+ append parallel(t,32)*/ 
  INTO DWSEAI01.DS_DET_DAILY t
  SELECT /*+ parallel(s,32)*/ * FROM (
WITH GDW AS (SELECT FACT_T.ORD_MO_YR_KEY_NO,
  FACT_T.OPER_CNTRY_KEY_NO,
  FACT_T.ORD_NO,
  FACT_T.ORD_LN_NO,
  ORD_DIM.ORGNL_ORD_NO                       AS ORG_ORD_ID,
  CAST(ORD_DIM.INV_NO AS VARCHAR2(240 CHAR)) AS INV_CD,
  DISP_T.ORD_LN_DISP_CD,
  ORD_CD_T.ORD_TYPE_CD,
  SALES_CHN.GLBL_SALES_CHNL_CD AS ORD_CHANNEL,
  ORD_CD_T.DROP_CD,
  WHSE_CD.WHSE_CD                                    AS WHSE_CD,
  WHSE_CD_ORD.WHSE_CD                                AS ORD_WHSE_CD,
  POSTL_CD_T.POSTL_CD                                AS SHP_POSTAL_CD,
  CAST(CNTRY_DIM_SHP.AMWAY_CNTRY_CD AS NUMBER(38,0)) AS SHP_CNTRY_ID,
  CASE
    WHEN ORD_CD_T.CANC_FLG='Y'
    THEN 'true'
    ELSE 'false'
  END                  AS ORD_CANC_FLAG,
  ORD_CD_T.PAY_REQ_FLG AS PAY_REQ_FLAG,
  FACT_T.REF_ORD_LN_NO AS REF_LN_ID,
  CASE
    WHEN ORD_CD_T.SHP_FLG='Y'
    THEN 'true'
    ELSE 'false'
  END AS ORD_SHP_FLAG
FROM
  (SELECT *
  FROM DWSAVR02.DWV10612_DMAND_ORD_DTL_FACT_L
  WHERE ORD_MO_YR_KEY_NO=YM
  AND OPER_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) FACT_T
LEFT JOIN DWSAVR02.DWV00710_ORD_CD_DIM ORD_CD_T
ON FACT_T.ORD_CD_KEY_NO =ORD_CD_T.ORD_CD_KEY_NO
LEFT JOIN DWSAVR02.DWV00720_ORD_LN_DIM DISP_T
ON FACT_T.ORD_LN_KEY_NO =DISP_T.ORD_LN_KEY_NO
LEFT JOIN DWSAVR02.AWV00004_CNTRY_AFF_DIM CNTRY_DIM_SHP
ON FACT_T.SHP_CNTRY_KEY_NO=CNTRY_DIM_SHP.CNTRY_KEY_NO
LEFT JOIN DWSAVR02.DWV00540_POSTL_CD_DIM POSTL_CD_T
ON FACT_T.SHP_POSTL_CD_KEY_NO=POSTL_CD_T.POSTL_CD_KEY_NO
LEFT JOIN DWSAVR02.AWV00090_WHSE_DIM WHSE_CD
ON FACT_T.WHSE_KEY_NO=WHSE_CD.WHSE_KEY_NO
LEFT JOIN DWSAVR02.AWV00090_WHSE_DIM WHSE_CD_ORD
ON FACT_T.ORD_WHSE_KEY_NO=WHSE_CD_ORD.WHSE_KEY_NO
LEFT JOIN
  (SELECT ORD_KEY_NO,
    ORGNL_ORD_NO,
    INV_NO
  FROM DWSAVR02.DWV02010_ORD_DIM
  WHERE CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) ORD_DIM
ON FACT_T.ORD_KEY_NO=ORD_DIM.ORD_KEY_NO
LEFT JOIN DWSAVR02.DWV02011_ORD_GLBL_SALES_CHNL SALES_CHN
ON FACT_T.GLBL_SALES_CHNL_KEY_NO=SALES_CHN.GLBL_SALES_CHNL_KEY_NO)
-----Main
SELECT CNTRY_DIM.AFF_ID                          AS OPER_AFF_ID,
  CAST(CNTRY_DIM.AMWAY_CNTRY_CD AS NUMBER(38,0)) AS OPER_CNTRY_ID,
  GDW.SHP_CNTRY_ID,
  TO_DATE(DEMAND_SALES.ORD_DT_KEY_NO, 'YYYYMMDD') AS ORD_DT,
  DEMAND_SALES.ORD_DT_KEY_NO,
  DEMAND_SALES.ORD_MO_YR_KEY_NO                   AS ORD_MO_YR_ID,
  TO_DATE(DEMAND_SALES.SHP_DT_KEY_NO, 'YYYYMMDD') AS SHP_DT,
  DEMAND_SALES.SHP_DT_KEY_NO,
  CAST(DEMAND_SALES.SHP_DT_KEY_NO/100 AS INTEGER) AS SHP_MO_YR_ID,
  CASE
    WHEN DEMAND_SALES.COMB_ORD_FLG=1
    THEN 'true'
    WHEN DEMAND_SALES.COMB_ORD_FLG=0
    THEN 'false'
  END                              AS COMB_ORD_FLAG,
  DEMAND_SALES.COMB_ORD_NO         AS COMB_ORD_ID,
  DEMAND_SALES.ORD_NO              AS ORD_ID,
  GDW.INV_CD AS INV_CD,
  CURCY_T.CURCY_CD,
  GDW.ORD_CHANNEL,
  GDW.WHSE_CD,
  GDW.ORD_WHSE_CD,
  GDW.SHP_POSTAL_CD,
  MAST_T_BILL.IMC_NO AS ACCOUNT_ID,
  CAST(NULL AS VARCHAR2(8 BYTE)) AS ACCOUNT_TYPE_ORD,
  MAST_T_VOL.IMC_NO  AS VOL_ACCOUNT_ID,
  MAST_T_ORD.IMC_NO  AS ORD_ACCOUNT_ID,
  MAST_T_SHP.IMC_NO  AS SHP_ACCOUNT_ID,
  GDW.ORD_CANC_FLAG,
  GDW.ORD_SHP_FLAG,
  GDW.PAY_REQ_FLAG,
  CAST(NULL AS VARCHAR2(5 BYTE)) AS ORD_PAID_FLAG,
  GDW.ORG_ORD_ID,
  GDW.ORD_TYPE_CD,
  GDW.DROP_CD,
  CAST(NULL AS NUMBER) AS DELIVERY_FEE_NET,
  DEMAND_SALES.ORD_LN_NO AS ORD_LN_ID,
  GDW.REF_LN_ID,
  ORD_LN_DISP_CD,
  ITEM_DIM_ORD.ITEM_CD          AS ORD_ITEM_CD,
  ITEM_DIM_SHP.ITEM_CD          AS SHP_ITEM_CD,
  ITEM_DIM_ORD.ITEM_BASE_CD     AS ORD_ITEM_BASE_CD,
  ITEM_DIM_SHP.ITEM_BASE_CD     AS SHP_ITEM_BASE_CD,
  DEMAND_SALES.IBO_PRICE_LC_AMT AS ADJ_LN_LC_NET,
  DEMAND_SALES.PV_LC_AMT        AS ADJ_LN_PV,
  DEMAND_SALES.BV_LC_AMT        AS ADJ_LN_BV,
  DEMAND_SALES.ORD_QTY          AS ORD_QTY,
  DEMAND_SALES.SHP_QTY          AS SHP_QTY,
  DEMAND_SALES.DELIVERYMODE     AS DELIVERY_MODE_CD,
  DEMAND_SALES.CONSULTANT_ID    AS CONSULTANT_CD,
  CAST(SYSDATE AS TIMESTAMP(6)) AS UPDATE_DT
FROM
  (SELECT *
  FROM DWSEAI01.DEMAND_SALES_DET_RAW
  WHERE ORD_MO_YR_KEY_NO =YM
  AND OPER_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) DEMAND_SALES
LEFT JOIN DWSAVR02.AWV00004_CNTRY_AFF_DIM CNTRY_DIM
ON DEMAND_SALES.OPER_CNTRY_KEY_NO=CNTRY_DIM.CNTRY_KEY_NO
LEFT JOIN
  (SELECT DISTINCT CURCY_CD, CURCY_KEY_NO FROM DWSEAI01.EXCH_RATES
  ) CURCY_T
ON DEMAND_SALES.CURCY_KEY_NO=CURCY_T.CURCY_KEY_NO
LEFT JOIN
  (SELECT IMC_NO,
    IMC_KEY_NO
  FROM DWSAVR02.DWV01021_IMC_MASTER_DIM
  WHERE IMC_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) MAST_T_VOL
ON DEMAND_SALES.VOL_IMC_KEY_NO=MAST_T_VOL.IMC_KEY_NO
LEFT JOIN
  (SELECT IMC_NO,
    IMC_KEY_NO
  FROM DWSAVR02.DWV01021_IMC_MASTER_DIM
  WHERE IMC_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) MAST_T_ORD
ON DEMAND_SALES.ORD_IMC_KEY_NO=MAST_T_ORD.IMC_KEY_NO
LEFT JOIN
  (SELECT IMC_NO,
    IMC_KEY_NO
  FROM DWSAVR02.DWV01021_IMC_MASTER_DIM
  WHERE IMC_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) MAST_T_SHP
ON DEMAND_SALES.SHP_IMC_KEY_NO=MAST_T_SHP.IMC_KEY_NO
LEFT JOIN
  (SELECT IMC_NO,
    IMC_KEY_NO
  FROM DWSAVR02.DWV01021_IMC_MASTER_DIM
  WHERE IMC_CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) MAST_T_BILL
ON DEMAND_SALES.IMC_KEY_NO=MAST_T_BILL.IMC_KEY_NO
LEFT JOIN
  (SELECT ITEM_KEY_NO,
    TRIM(ITEM_NO) AS ITEM_CD,
    CASE
      WHEN INSTR(REGEXP_REPLACE(SUBSTR(TRIM(ITEM_NO), 4, LENGTH(TRIM(ITEM_NO))                         -3), '[B-Z]', 'A'), 'A')>0
      THEN SUBSTR(TRIM(ITEM_NO), 1, INSTR(REGEXP_REPLACE(SUBSTR(TRIM(ITEM_NO), 4, LENGTH(TRIM(ITEM_NO))-3), '[B-Z]', 'A'), 'A')+ 2)
      ELSE TRIM(ITEM_NO)
    END AS ITEM_BASE_CD
  FROM DWSAVR02.DWV03000_ITEM_DIM
  WHERE CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) ITEM_DIM_ORD
ON DEMAND_SALES.ORD_ITEM_KEY_NO=ITEM_DIM_ORD.ITEM_KEY_NO
LEFT JOIN
  (SELECT ITEM_KEY_NO,
    TRIM(ITEM_NO) AS ITEM_CD,
    CASE
      WHEN INSTR(REGEXP_REPLACE(SUBSTR(TRIM(ITEM_NO), 4, LENGTH(TRIM(ITEM_NO))                         -3), '[B-Z]', 'A'), 'A')>0
      THEN SUBSTR(TRIM(ITEM_NO), 1, INSTR(REGEXP_REPLACE(SUBSTR(TRIM(ITEM_NO), 4, LENGTH(TRIM(ITEM_NO))-3), '[B-Z]', 'A'), 'A')+ 2)
      ELSE TRIM(ITEM_NO)
    END AS ITEM_BASE_CD
  FROM DWSAVR02.DWV03000_ITEM_DIM
  WHERE CNTRY_KEY_NO IN (5,26,23,134,56,39,76,34,74,75,17,54,48,16,44,57,10,8,47,18,14,11,46,45,30,37,29,27,13,32,6,42,114,41)
  ) ITEM_DIM_SHP
ON DEMAND_SALES.SHP_ITEM_KEY_NO=ITEM_DIM_SHP.ITEM_KEY_NO
LEFT JOIN GDW GDW
ON DEMAND_SALES.OPER_CNTRY_KEY_NO=GDW.OPER_CNTRY_KEY_NO
AND DEMAND_SALES.ORD_MO_YR_KEY_NO=GDW.ORD_MO_YR_KEY_NO
AND DEMAND_SALES.ORD_NO=GDW.ORD_NO
AND DEMAND_SALES.ORD_LN_NO=GDW.ORD_LN_NO) s;
COMMIT;
END LOOP;
END;
